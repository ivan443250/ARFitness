# Киберфизиологический спорт (КФС)

AR/AI‑симулятор тренировок и соревнований с GPS/QR чекпоинтами, интеллектуальными заданиями (промт‑инжиниринг) и геймификацией.  
Три ключевые роли: **участник**, **тренер/организатор**, **судья**. Поддержка офлайн‑прохождения и антифрод‑проверок.

## Содержание
- [Возможности](#возможности)
- [Архитектура и стек](#архитектура-и-стек)
- [Структура репозитория](#структура-репозитория)
- [Быстрый старт](#быстрый-старт)
- [Конфигурация (.env)](#конфигурация-env)
- [Основные алгоритмы](#основные-алгоритмы)
- [Схема данных](#схема-данных)
- [API (обзор)](#api-обзор)
- [Тестирование](#тестирование)
- [Критерии приёмки MVP](#критерии-приёмки-mvp)
- [Дорожная карта](#дорожная-карта)
- [Безопасность и приватность](#безопасность-и-приватность)
- [Контрибьютинг и лицензия](#контрибьютинг-и-лицензия)

---

## Возможности

### Участник
- Регистрация/профиль, календарь тренировок и челленджей.  
- Старт активности: синхронизация времени, сброс шагомера, индикация начала.  
- Прохождение маршрута: GPS‑контроль + скан **QR/AR‑маркера**, выполнение физ. упражнений (акселерометр/камера).  
- Интеллектуальные задания: составление промта по теме чекпоинта, авто‑валидация структуры/содержания.  
- Страница результатов, рекомендации ИИ, сравнение с прогрессом и рейтингами (общий/лиги/команда).

### Тренер/Организатор
- Веб‑панель: **конструктор маршрутов** (3–20 чекпоинтов), радиусы 10–100 м, геометрические шаблоны (круг/линия/многоугольник), «мастер фигур».  
- Программы активностей: шаблоны, группы/команды, тайминги, экспорт и печать QR‑кодов.  
- Мониторинг и аналитика: статусы, логи, тепловые карты, проблемные точки.  
- Симулятор для тестирования маршрутов с фейковыми координатами.

### Судья
- Дашборд события: карта с треками и радиусами, таблица аномалий (скорости, множественные сканы, пропуски).  
- Разбор спорных кейсов: подтвердить/аннулировать/пересдача. Авто‑протоколы и отчёты.

---

## Архитектура и стек
- **Мобильный клиент (Unity/C#)**: AR Foundation, GPS/акселерометр, QR‑scanner (ZXing/MLKit), офлайн‑кэш.  
- **Веб‑панель (React/JS/PWA)**: Mapbox GL JS / Google Maps JS API, конструктор маршрутов, админка тренера и судьи.  
- **Бэкенд (Firebase/Node.js)**: Firestore, Cloud Functions, Cloud Storage, Push/FCM, аналитика.  
- **Интеграции**:  
  - Map SDK: Mapbox или Google Maps  
  - Fitness API: HealthKit / Google Fit  
  - AI API: LLM для оценки промтов (или правиловая валидция без LLM)  
  - NFT SDK: Thirdweb/Enjin (опционально)  
  - **Опция**: AR‑очки Rokid Air через UXR 3.0 как компаньон к смартфону.

---

## Структура репозитория

```
kfs/
├─ apps/
│  ├─ mobile/            # Unity‑проект (Android/iOS, AR Foundation)
│  ├─ web-admin/         # React‑панель тренера/судьи (PWA)
│  └─ web-landing/       # Публичный лендинг (опционально)
├─ services/
│  └─ firebase/          # Cloud Functions, эмуляторы, rules, firestore.indexes.json
├─ packages/
│  ├─ shared-types/      # Общие модели TypeScript/C#
│  └─ route-logic/       # Генераторы фигур/проверки (TS + C# порт)
├─ docs/                 # Спецификации, схемы, макеты
└─ README.md
```

> Рекомендуется монорепозиторий на pnpm/yarn workspaces для общих типов и логики.

---

## Быстрый старт

### Предустановки
- Node.js ≥ 18, pnpm/yarn, Firebase CLI  
- Unity 2022.3 LTS (рекомендовано), Android/iOS SDK  
- Аккаунты Mapbox/Google Maps, Firebase проект

### Клонирование
```bash
git clone https://github.com/<org>/kfs.git
cd kfs
```

### Веб‑панель
```bash
cd apps/web-admin
cp .env.example .env.local   # заполните ключи
pnpm i
pnpm dev
```

### Бэкенд (локальные эмуляторы)
```bash
cd services/firebase
cp .env.example .env
pnpm i
pnpm emu   # alias: firebase emulators:start
```

### Мобильный клиент
1. Откройте `apps/mobile` в Unity.  
2. Установите пакеты: AR Foundation, ARCore/ARKit XR Plugins, QR‑scanner.  
3. Введите ключи в `Resources/AppConfig.asset` (создаётся из шаблона).  
4. Соберите билд под Android/iOS.

---

## Конфигурация (.env)

**Общие**
- `MAPBOX_TOKEN` или `GOOGLE_MAPS_API_KEY`  
- `OPENAI_API_KEY` (если включена оценка промтов LLM)  
- `NFT_PROVIDER` (`thirdweb`/`enjin`), `NFT_API_KEY` (опционально)

**Firebase**
- `FIREBASE_API_KEY`, `FIREBASE_PROJECT_ID`, `FIREBASE_APP_ID`, `FIREBASE_MESSAGING_SENDER_ID`, `FIREBASE_STORAGE_BUCKET`  
- `CONTROL_HASH_SECRET` (HMAC для QR payload)  
- `AES_SECRET` (шифрование персональных данных)

**Правила/пороговые значения**
- `DEFAULT_RADIUS=20` (м)  
- `HDOP_THRESHOLD=2.0` и `RADIUS_INCREMENT=10` (м при плохом сигнале)  
- `RUN_SPEED_MAX=12` (м/с), `WALK_SPEED_MAX=2` (м/с)  
- `MIN_CP_DISTANCE=30` (м), `MAX_CP_COUNT=20`

---

## Основные алгоритмы

### Условие засчитывания чекпоинта
- Вход в настраиваемый радиус 10–100 м (расстояние по **Haversine**).  
- Подтверждение QR в течение окна (например, 120 сек) после входа в радиус.  
- Фиксация времени на сервере: вход, скан, окончание упражнения.

### Деградация при плохом сигнале
- Динамическое увеличение радиуса на **+10 м при HDOP > 2.0**, с логированием корректировок.  
- Режимы `GPS+QR`, `GPS-Only` (тренировки), `QR-Only` (в помещениях).

### Антифрод
- Флаги аномалий: **скорость выше порога**, «телепорт», повторные сканы, недостаточное время в радиусе.  
- Логирование в Firestore `attempts.logs` (`timestamp`, `speed`, `flagType`: `SPEED_ANOMALY`, `TELEPORT`, `REPEAT_SCAN`).

### Генерация маршрутов
- Круг / Линия (змейка) / Многоугольник + «мастер фигур» (шаг 10–100 м, поворот, сдвиг).  
- Валидатор: мин. дистанция между точками ≥ 30 м, оценка общей дистанции и времени.  
- Для MVP допустим упрощённый режим: только круг или ручная расстановка.

---

## Схема данных (Firestore, укороченно)

```
routes: {
  id, ownerId, city, visibility, checkpoints[], defaultRadius, createdAt, version
}
checkpoints: {
  id, routeId, lat, lng, radius, requiredScan, exerciseSpec, promptRulesetId, qrControlHash
}
events: { id, routeId, startWindow, groups[], visibility, status }
attempts: { id, userId, routeId, eventId, state, logs[] }
logs: { timestamp, lat, lng, accuracy, action, extras }
```

Роли и правила доступа: `trainer`, `judge`, `participant` (минимально необходимые права).

---

## API (обзор)

Cloud Functions (примеры):
- `POST /validate-qr` — проверка подписи QR (HMAC), окно действия.  
- `POST /log-event` — приём телеметрии (вход в радиус, скан, упражнение, промт).  
- `GET /routes/:id` — получение маршрута и чекпоинтов (с версией).  
- `POST /anti-fraud/check` — расчёт скоростей между точками, флаги аномалий.  
- `GET /leaderboard` — рейтинги (общий/лига/группа).  
- `POST /judge/resolve` — действия судьи по спорным кейсам.

---

## Тестирование

- **Unity Test Framework**: юнит‑тесты генератора фигур и Haversine; проверка шагов/радиусов.  
- **Web/Jest**: генерация маршрутов в конструкторе, валидация форм.  
- **Эмуляторы Firebase**: интеграционные тесты функций и правил безопасности.  
- **Нагрузочные тесты**: массовые старты, задержки синхронизации.

---

## Критерии приёмки MVP
- Конструктор собирает маршрут из ~10 точек за **3–5 минут**, печать QR и публикация.  
- При радиусе 30 м — **≤3%** ложных отказов засчитывания на слабом GPS.  
- Серверные логи фиксируют последовательность состояний по каждой точке.  
- Офлайн‑прохождение с последующей синхронизацией **без потери целостности** логов.  
- Редактирование маршрута создаёт **новую версию**, старые попытки привязаны к своей версии.

---

## Дорожная карта

**MVP**
- Тренировки + базовый конструктор (круг/ручная расстановка), QR, антифрод, офлайн‑кэш.  
- Публичные/частные маршруты, группы, базовые рейтинги.

**MMP+**
- Полный «мастер фигур», расширенная аналитика/теплокарты.  
- Оценка промтов LLM, персональные рекомендации.  
- Инвентарь/NFT‑награды.  
- Опциональная интеграция с **Rokid Air** (голос/жесты).

---

## Безопасность и приватность
- Шифрование персональных данных **AES‑256**, доступ по ролям (Firebase Security Rules).  
- Хранение данных минимум **12 месяцев**.  
- Логирование всех корректировок радиусов (HDOP) и аномалий.  
- Соответствие требованиям GDPR/COPPA при работе с несовершеннолетними.

---

## Контрибьютинг и лицензия
- PR‑ы через feature‑ветки, линт/тесты обязательны (Husky pre‑commit).  
- Issues: баги, предложения по UX/алгоритмам, новые шаблоны маршрутов.  
- Лицензия: укажите `LICENSE` согласно договорённостям.
